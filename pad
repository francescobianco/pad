#!/usr/bin/env bash
set -e

PAD_SOCKET=/home/pad/.socket
PAD_OUTPUT="nc -q0 -U $PAD_SOCKET"
TMP_HOME="$(getent passwd $(logname) | cut -d: -f6)"
SSH_LOGIN="ssh -i ${TMP_HOME}/.ssh/pad -oStrictHostKeyChecking=no -t $(logname)@$(hostname)"

source $HOME/.padrc

error() { echo $1; exit 1; }

if [ -z "$1" ]; then
  ${PAD_OUTPUT}
elif [ "$1" = "start" ]; then
  clear
  nc -lkU "$PAD_SOCKET"
elif [ "$1" = "clear" ]; then
  clear | ${PAD_OUTPUT}
elif [ "$1" = "config" ]; then
  [[ $EUID -ne 0 ]] && error "sudo required"
  echo "Set SSH password for the pad user"
  passwd -q pad
elif [ "$1" = "note" ]; then
  echo "Your pad is ready to edit..."
  nano ${HOME}/.notes | ${PAD_OUTPUT}
elif [ "$1" = "bash" ]; then
  bash
elif [ "$1" = "shell" ]; then
  $SSH_LOGIN /bin/bash -i | ${PAD_OUTPUT}
elif [ "$1" = "info" ]; then
  $SSH_LOGIN pad ssh-info | ${PAD_OUTPUT}
elif [ "$1" = "ssh-info" ]; then
  $SSH_LOGIN pad ssh-info | ${PAD_OUTPUT}
else
  echo "Please! Watch on pad... "
  exec "$@" | ${PAD_OUTPUT}
fi
